#!/bin/bash

source `dirname $0`/../colors.bash
source `dirname $0`/../git.bash

all=$(parse_all_parameter "$@");
head_wd=$(pwd);

while read line; do (  
  cd $line;
  wd=$(pwd);
  prefix=${wd#$head_wd};
  if [[ $wd != $prefix || -n $all ]]; then
    echo -e "${LIGHT_BLUE}${wd/$HOME/~}${NC} $(__git_ps1_mz)";
    
    GIT_PS1_SHOWUPSTREAM="git";
    unset GIT_PS1_SHOWCOLORS;
    status=$(__git_ps1_mz);
    branch="$(git symbolic-ref HEAD 2>/dev/null)";
    if [[ $status == "(${branch##refs/heads/}<)" ]]; then
      echo "merging....";
      git merge --verbose @{upstream};

      GIT_PS1_SHOWUPSTREAM="git verbose";
      GIT_PS1_SHOWCOLORS="true";
      echo -e "${LIGHT_BLUE}${wd/$HOME/~}${NC} $(__git_ps1_mz)";
    fi
  fi
) done <$HOME/.mgitrepos
